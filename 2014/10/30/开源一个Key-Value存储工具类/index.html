<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>开源一个Key-Value存储工具类 | Alienchang’s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言还记得大学刚学数据库那会儿，天真地以为世界上所有的存储都需要用数据库来做。后来毕业后，正值NOSQL流行，那时我在网易参与了网易微博的开发，我们当时使用了有道自己做的“BigTable”— OMAP来存储微博数据，那个时候才发现，其实Key-Value这种简单的存储也能搞定微博这类不太简单的存储逻辑。
相比MYSQL，当数据量上千万后，NOSQL的优势体现出来了：对于海量数据，NOSQL在存取">
<meta property="og:type" content="article">
<meta property="og:title" content="开源一个Key-Value存储工具类">
<meta property="og:url" content="http://yoursite.com/2014/10/30/开源一个Key-Value存储工具类/index.html">
<meta property="og:site_name" content="Alienchang’s Blog">
<meta property="og:description" content="前言还记得大学刚学数据库那会儿，天真地以为世界上所有的存储都需要用数据库来做。后来毕业后，正值NOSQL流行，那时我在网易参与了网易微博的开发，我们当时使用了有道自己做的“BigTable”— OMAP来存储微博数据，那个时候才发现，其实Key-Value这种简单的存储也能搞定微博这类不太简单的存储逻辑。
相比MYSQL，当数据量上千万后，NOSQL的优势体现出来了：对于海量数据，NOSQL在存取">
<meta property="og:image" content="http://yoursite.com/img/share key-value database/1.jpg">
<meta property="og:updated_time" content="2015-01-11T11:02:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="开源一个Key-Value存储工具类">
<meta name="twitter:description" content="前言还记得大学刚学数据库那会儿，天真地以为世界上所有的存储都需要用数据库来做。后来毕业后，正值NOSQL流行，那时我在网易参与了网易微博的开发，我们当时使用了有道自己做的“BigTable”— OMAP来存储微博数据，那个时候才发现，其实Key-Value这种简单的存储也能搞定微博这类不太简单的存储逻辑。
相比MYSQL，当数据量上千万后，NOSQL的优势体现出来了：对于海量数据，NOSQL在存取">
  
  
    <link rel="icon" href="/placeholder.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

  <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<div class="profilepic">
			<img src="/img/header.jpeg">
		</div>

		<hgroup>
		  <h1 class="header-author"><a href="/">Alienchang</a></h1>
		</hgroup>

		
		<p class="header-subtitle">不急不躁，勇往直前</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/categories/技术">Objective-C</a></li>
				        
							<li><a href="/categories/Xcode">Xcode</a></li>
				        
							<li><a href="/instagram">相册</a></li>
				        
							<li><a href="/about">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/Alienchang" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/2763472470/profile?topnav=1&wvr=6" title="weibo">weibo</a>
					        
								<a class="facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100003995623398" title="facebook">facebook</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud">
						<a href="/tags/Xcode/" style="font-size: 14px;">Xcode</a> <a href="/tags/code/" style="font-size: 10px;">code</a> <a href="/tags/ios/" style="font-size: 20px;">ios</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/xcode/" style="font-size: 12px;">xcode</a> <a href="/tags/小知识/" style="font-size: 18px;">小知识</a> <a href="/tags/技术/" style="font-size: 16px;">技术</a> <a href="/tags/服务器/" style="font-size: 10px;">服务器</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://iostang.github.io">唐先森的博客</a>
			        
				</section>
				

				
			</div>
		</div>
	</header>				
</div>
<a href="https://github.com/you"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/c6625ac1f3ee0a12250227cf83ce904423abf351/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_gray_6d6d6d.png"></a>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay"></div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src="/img/header.jpeg">
			</div>

			<hgroup>
			  <h1 class="header-author"><a href="/">Alienchang</a></h1>
			</hgroup>
			
			<p class="header-subtitle">不急不躁，勇往直前</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/技术">Objective-C</a></li>
		        
					<li><a href="/categories/Xcode">Xcode</a></li>
		        
					<li><a href="/instagram">相册</a></li>
		        
					<li><a href="/about">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Alienchang" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/2763472470/profile?topnav=1&wvr=6" title="weibo">weibo</a>
			        
						<a class="facebook" target="_blank" href="https://www.facebook.com/profile.php?id=100003995623398" title="facebook">facebook</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <article id="post-开源一个Key-Value存储工具类" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2014/10/30/开源一个Key-Value存储工具类/" class="article-date">
  	<time datetime="2014-10-30T04:44:19.000Z" itemprop="datePublished">10月 30 2014</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/技术/">技术</a>
  </div>

      
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      开源一个Key-Value存储工具类
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言">前言</h2><p>还记得大学刚学数据库那会儿，天真地以为世界上所有的存储都需要用数据库来做。后来毕业后，正值NOSQL流行，那时我在网易参与了网易微博的开发，我们当时使用了有道自己做的“BigTable”— OMAP来存储微博数据，那个时候才发现，其实Key-Value这种简单的存储也能搞定微博这类不太简单的存储逻辑。</p>
<p>相比MYSQL，当数据量上千万后，NOSQL的优势体现出来了：对于海量数据，NOSQL在存取速度上没有任何影响，另外，天生的多备份和分布式，也说数据安全和扩容变得异常容易。</p>
<h2 id="iOS端的尝试">iOS端的尝试</h2><p>后来我从后台转做iOS端的开发，我就尝试了在iOS端直接使用Key-Value式的存储。经过在粉笔网、猿题库、小猿搜题三个客户端中的尝试后，我发现Key-Value式的存储不但完全能够满足大多数移动端开发的需求，而且非常适合移动端采用。主要原因是：移动端存储的数据量不会很大：</p>
<ul>
<li>如果是单机的应用（例如效率工具Clear），用户自己一个人创建的数据最多也就上万条。</li>
<li>如果是有服务端的应用（例如网易新闻，微博），那移动端通常不会保存全量的数据，每次会从服务器上获取数据，本地只是做一些内容的缓存而已，所以也不会有很大的数据量。<br>如果数据量不大的话，那么在iOS端使用最简单直接的Key-Value存储就能带来开发上的效率优势。它能保证：</li>
</ul>
<ol>
<li>Model层的代码编写简单，易于测试。</li>
<li>由于Value是JSON格式，所以在做Model字段更改时，易于扩展和兼容。</li>
</ol>
<h2 id="实现方案">实现方案</h2><p>在存储引擎上，2年前我直接选择了Sqlite当做存储引擎，相当于每个数据库表只有Key，Value两个字段。后来，随着LevelDB的流行，业界也有一些应用采用了LevelDB来做iOS端的Key-Value存储引擎，例如开源的<a href="https://github.com/viewfinderco/viewfinder" target="_blank" rel="external">ViewFinder</a>。</p>
<p>因为LevelDB本身并不是为移动端设计的，我担心它过于占用内存，我自己也没有看到业界有在移动端针对LevelDB做很详细的测试，连LevelDB的iOS端移植都不是官方做的。加上我自己写的基于Sqlite的Key-Value存储用着也没有什么问题，所以我也就一直没有更换成LevelDB。</p>
<h2 id="开源">开源</h2><p>经过两年的使用和测试，我认为它非常好用，而且代码也非常简单，只有不到400行。所以现在开源分享给大家，这个项目叫<a href="https://github.com/yuantiku/YTKKeyValueStore" target="_blank" rel="external">YTKKeyValueStore</a>，项目代码在<a href="https://github.com/yuantiku/YTKKeyValueStore" target="_blank" rel="external">这里</a></p>
<p>以下是一个简单的使用示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">YTKKeyValueStore *store = [[YTKKeyValueStore alloc] initDBWithName:@<span class="string">"test.db"</span>];</span><br><span class="line">NSString *tableName = @<span class="string">"user_table"</span>;</span><br><span class="line">[store createTableWithName:tableName];</span><br><span class="line">// 保存</span><br><span class="line">NSString *key = @<span class="string">"1"</span>;</span><br><span class="line">NSDictionary *user = @&#123;@<span class="string">"id"</span>: @<span class="number">1</span>, @<span class="string">"name"</span>: @<span class="string">"tangqiao"</span>, @<span class="string">"age"</span>: @<span class="number">30</span>&#125;;</span><br><span class="line">[store putObject:user withId:key intoTable:tableName];</span><br><span class="line">// 查询</span><br><span class="line">NSDictionary *queryUser = [store getObjectById:key fromTable:tableName];</span><br><span class="line">NSLog(@<span class="string">"query data result: %@"</span>, queryUser);</span><br></pre></td></tr></table></figure>
<h2 id="集成说明">集成说明</h2><p>使用本项目，你需要将开源代码中的<strong>YTKKeyValueStore.h</strong>和<strong>YTKKeyValueStore.m</strong>添加到你的工程中，并且在工程设置的Link Binary With Libraries中，增加libsqlite3.dylib，如下图所示：<br><img src="/img/share key-value database/1.jpg" style="width: 400px;"></p>
<p>由于时间关系，当前还未提供Cocoapods方式集成。</p>
<h2 id="使用说明">使用说明</h2><p>所有的接口都封装在<strong>YTKKeyValueStore</strong>类中。以下是一些常用方法说明。</p>
<h2 id="打开（或创建）数据库">打开（或创建）数据库</h2><p>通过initDBWithName方法，即可在程序的Document目录打开指定的数据库文件。如果该文件不存在，则会创建一个新的数据库。</p>
<pre><code class="bash">// 打开名为test.db的数据库，如果该文件不存在，则创新一个新的。
YTKKeyValueStore *store = [[YTKKeyValueStore alloc] initDBWithName:@<span class="string">"test.db"</span>];
</code></pre>
<h2 id="创建数据库表">创建数据库表</h2><p>通过<strong>createTableWithName</strong>方法，我们可以在打开的数据库中创建表，如果表名已经存在，则会忽略该操作。如下所示：</p>
<pre><code class="bash">YTKKeyValueStore *store = [[YTKKeyValueStore alloc] initDBWithName:@<span class="string">"test.db"</span>];
NSString *tableName = @<span class="string">"user_table"</span>;
// 创建名为user_table的表，如果已存在，则忽略该操作
[store createTableWithName:tableName];
</code></pre>
<h2 id="读写数据">读写数据</h2><p><strong>YTKKeyValueStore</strong>类提供key-value的存储接口，存入的所有数据需要提供key以及其对应的value，读取的时候需要提供key来获得相应的value。</p>
<p><strong>YTKKeyValueStore</strong>类支持的value类型包括：NSString, NSNumber, NSDictionary和NSArray，为此提供了以下接口：</p>
<pre><code class="bash">- (void)putString:(NSString *)string withId:(NSString *)stringId intoTable:(NSString *)tableName;
- (void)putNumber:(NSNumber *)number withId:(NSString *)numberId intoTable:(NSString *)tableName;
- (void)putObject:(id)object withId:(NSString *)objectId intoTable:(NSString *)tableName;
</code></pre>
<p>与此对应，有以下value为NSString, NSNumber, NSDictionary和NSArray的读取接口：</p>
<pre><code class="bash">- (NSString *)getStringById:(NSString *)stringId fromTable:(NSString *)tableName;
- (NSNumber *)getNumberById:(NSString *)numberId fromTable:(NSString *)tableName;
- (id)getObjectById:(NSString *)objectId fromTable:(NSString *)tableName;
</code></pre>
<h2 id="删除数据接口">删除数据接口</h2><p><strong>YTKKeyValueStore</strong>提供了以下接口用于删除数据。</p>
<pre><code class="bash">// 清除数据表中所有数据
- (void)clearTable:(NSString *)tableName;

// 删除指定key的数据
- (void)deleteObjectById:(NSString *)objectId fromTable:(NSString *)tableName;

// 批量删除一组key数组的数据
- (void)deleteObjectsByIdArray:(NSArray *)objectIdArray fromTable:(NSString *)tableName;

// 批量删除所有带指定前缀的数据
- (void)deleteObjectsByIdPrefix:(NSString *)objectIdPrefix fromTable:(NSString *)tableName;
</code></pre>
<h2 id="更多接口">更多接口</h2><p><strong>YTKKeyValueStore</strong>还提供了以下接口来获取表示内部存储的key-value对象。</p>
<pre><code class="bash">// 获得指定key的数据
- (YTKKeyValueItem *)getYTKKeyValueItemById:(NSString *)objectId fromTable:(NSString *)tableName;
// 获得所有数据
- (NSArray *)getAllItemsFromTable:(NSString *)tableName;
</code></pre>
<p>由于YTKKeyValueItem类带有createdTime字段，可以获得该条数据的插入（或更新）时间，以便上层做复杂的处理（例如用来做缓存过期逻辑）。</p>
<h2 id="其它">其它</h2><p>两年前写过不少测试用例，后来给弄丢了，所以现在开项项目中还没有测试用例。由于时间关系，更详细的使用说明稍后会更新到项目中。</p>
<p>Posted by 唐巧 Oct 3rd, 2014 <a href="http://blog.devtang.com/blog/categories/ios/" target="_blank" rel="external">iOS</a></p>
<p>原创文章，版权声明：自由转载-非商用-非衍生-保持署名 | Creative Commons BY-NC-ND 3.0</p>

      
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2014/10/30/获得当前时区时间/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">&lt;</strong>
      <div class="article-nav-title">
        
          获得当前时区时间
        
      </div>
    </a>
  
  
    <a href="/2014/09/23/xcode5国际化配置/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">xcode5国际化配置</div>
      <strong class="article-nav-caption">&gt;</strong>
    </a>
  
</nav>

  
</article>






      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2015 Alienchang
    	</div>
      	<div class="footer-right">

      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
  <script src="/js/main.js" type="text/javascript"></script>

  </div>
</body>
</html>